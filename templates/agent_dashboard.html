<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Detection Agent Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // SVG Icons
        const Play = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const Pause = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const CheckCircle = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const AlertCircle = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const TrendingUp = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const Database = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>;
        const Clock = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const Activity = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>;

        const LiveAgentDashboard = () => {
            const [dashboardData, setDashboardData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(new Date());

            // Fetch dashboard data
            const fetchData = async () => {
                try {
                    const response = await fetch('/api/agent-dashboard/data');
                    const result = await response.json();
                    
                    if (result.success) {
                        setDashboardData(result.data);
                        setError(null);
                    } else {
                        setError(result.error || 'Failed to fetch data');
                    }
                } catch (err) {
                    setError('Agent service unavailable');
                    console.error('Fetch error:', err);
                } finally {
                    setLoading(false);
                    setLastUpdate(new Date());
                }
            };

            // Initial load and refresh every 30 seconds
            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 30000);
                return () => clearInterval(interval);
            }, []);

            // Handle action response
            const handleAction = async (actionId, response) => {
                try {
                    const res = await fetch('/api/agent-dashboard/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action_id: actionId, response })
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        // Refresh data after action
                        fetchData();
                        alert(result.message || 'Action completed');
                    } else {
                        alert(result.error || 'Action failed');
                    }
                } catch (err) {
                    alert('Failed to process action');
                }
            };

            // Trigger manual report
            const triggerReport = async () => {
                try {
                    const res = await fetch('/api/agent-dashboard/trigger-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        fetchData();
                        alert(result.message);
                    } else {
                        alert(result.message || 'No data to report');
                    }
                } catch (err) {
                    alert('Failed to trigger report');
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center">
                        <div className="text-white text-xl">ü§ñ Loading agent dashboard...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center">
                        <div className="bg-red-500/20 border border-red-400 rounded-xl p-6 max-w-md">
                            <div className="text-red-200 text-lg font-bold mb-2">‚ö†Ô∏è Agent Unavailable</div>
                            <div className="text-red-300">{error}</div>
                            <button 
                                onClick={fetchData}
                                className="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            const stats = dashboardData?.current_stats || {};
            const reports = dashboardData?.daily_reports || [];
            const actions = dashboardData?.pending_actions || [];

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-white mb-2">
                                        ü§ñ Autonomous Detection Agent
                                    </h1>
                                    <p className="text-purple-200">
                                        Live monitoring ‚Ä¢ Food Recognition Tracker
                                    </p>
                                </div>
                                <div className="text-right">
                                    <div className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg ${stats.is_running ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`}>
                                        <Activity />
                                        {stats.is_running ? 'Active' : 'Inactive'}
                                    </div>
                                    <div className="text-purple-300 text-sm mt-2">
                                        Last update: {lastUpdate.toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-blue-500/20 backdrop-blur border border-blue-400/30 rounded-xl p-4">
                                <Database className="text-blue-300 mb-2" />
                                <div className="text-2xl font-bold text-white">{stats.total_scans_today || 0}</div>
                                <div className="text-blue-200 text-sm">Scans Today</div>
                            </div>
                            
                            <div className="bg-orange-500/20 backdrop-blur border border-orange-400/30 rounded-xl p-4">
                                <AlertCircle className="text-orange-300 mb-2" />
                                <div className="text-2xl font-bold text-white">{stats.low_confidence_today || 0}</div>
                                <div className="text-orange-200 text-sm">Low Confidence Today</div>
                            </div>
                            
                            <div className="bg-green-500/20 backdrop-blur border border-green-400/30 rounded-xl p-4">
                                <TrendingUp className="text-green-300 mb-2" />
                                <div className="text-2xl font-bold text-white">{stats.average_confidence_today || 0}%</div>
                                <div className="text-green-200 text-sm">Avg Confidence Today</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Pending Actions */}
                            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                                <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                    <CheckCircle /> Pending Your Review
                                </h2>
                                
                                {actions.length === 0 ? (
                                    <div className="text-purple-200 text-center py-8">
                                        <div className="mb-4">‚úÖ No pending actions</div>
                                        <div className="text-sm">Agent is monitoring autonomously</div>
                                        <button 
                                            onClick={triggerReport}
                                            className="mt-4 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm"
                                        >
                                            üß™ Trigger Test Report
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {actions.map(action => (
                                            <div key={action.id} className="bg-white/5 rounded-lg p-4 border border-yellow-400/30">
                                                <div className="text-yellow-300 text-sm mb-2">
                                                    Day {action.day} ‚Ä¢ {action.category}
                                                </div>
                                                <div className="text-white font-semibold mb-2">{action.question}</div>
                                                <div className="text-purple-200 text-sm mb-3">
                                                    Based on {action.lowConfSamples} low-confidence samples
                                                </div>
                                                <div className="flex flex-wrap gap-2">
                                                    {action.options.map(option => (
                                                        <button
                                                            key={option}
                                                            onClick={() => handleAction(action.id, option)}
                                                            className="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-sm rounded-lg transition-colors"
                                                        >
                                                            {option}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Daily Reports */}
                            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                                <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                    <Clock /> Daily Progress Reports
                                </h2>
                                
                                <div className="space-y-4 max-h-96 overflow-y-auto">
                                    {reports.length === 0 ? (
                                        <div className="text-purple-200 text-center py-8">
                                            No reports yet. Agent generates reports every 24 hours.
                                        </div>
                                    ) : (
                                        reports.map(report => (
                                            <div key={report.day} className="bg-white/5 rounded-lg p-4 border border-white/10">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="text-white font-bold">Day {report.day} Report</div>
                                                    <div className="text-purple-300 text-sm">
                                                        {new Date(report.timestamp).toLocaleString()}
                                                    </div>
                                                </div>
                                                
                                                {/* Stats */}
                                                <div className="grid grid-cols-3 gap-2 mb-3 text-xs">
                                                    <div className="bg-blue-500/20 rounded p-2">
                                                        <div className="text-blue-300 font-semibold">{report.stats.total_scans}</div>
                                                        <div className="text-blue-200">Total Scans</div>
                                                    </div>
                                                    <div className="bg-orange-500/20 rounded p-2">
                                                        <div className="text-orange-300 font-semibold">{report.stats.low_confidence_count}</div>
                                                        <div className="text-orange-200">Low Conf</div>
                                                    </div>
                                                    <div className="bg-green-500/20 rounded p-2">
                                                        <div className="text-green-300 font-semibold">{report.stats.average_confidence}%</div>
                                                        <div className="text-green-200">Avg Conf</div>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-2 mb-3">
                                                    {report.activities.map((activity, idx) => (
                                                        <div key={idx} className="text-sm">
                                                            <div className="text-purple-200">{activity.description}</div>
                                                            {activity.details && (
                                                                <div className="text-purple-400 text-xs ml-4">{activity.details}</div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                {report.recommendations && report.recommendations.length > 0 && (
                                                    <div className="mt-3 pt-3 border-t border-white/10">
                                                        <div className="text-green-300 text-xs font-semibold mb-1">üí° Recommendations:</div>
                                                        {report.recommendations.map((rec, idx) => (
                                                            <div key={idx} className="text-green-200 text-xs ml-2">
                                                                ‚Ä¢ {rec.text}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Agent Workflow Info */}
                        <div className="mt-6 bg-white/5 backdrop-blur rounded-xl p-4 border border-white/10">
                            <h3 className="text-white font-semibold mb-2">üîÑ Autonomous Agent Workflow</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
                                <div className="text-purple-200">
                                    <span className="font-semibold text-blue-300">1. Monitor:</span> Track every food detection in real-time
                                </div>
                                <div className="text-purple-200">
                                    <span className="font-semibold text-purple-300">2. Analyze:</span> Identify low-confidence patterns
                                </div>
                                <div className="text-purple-200">
                                    <span className="font-semibold text-yellow-300">3. Suggest:</span> Propose training data improvements
                                </div>
                                <div className="text-purple-200">
                                    <span className="font-semibold text-green-300">4. Report:</span> Daily updates on system performance
                                </div>
                            </div>
                        </div>

                        {/* Integration Status */}
                        <div className="mt-4 bg-green-500/10 border border-green-400/30 rounded-xl p-4">
                            <div className="flex items-center gap-3">
                                <div className="text-green-300 text-2xl">‚úì</div>
                                <div>
                                    <div className="text-green-200 font-semibold">
                                        Live Integration Active
                                    </div>
                                    <div className="text-green-300 text-sm">
                                        Agent is monitoring your production food detection system at{' '}
                                        <a href="https://food-recognition-tracker.onrender.com" className="underline" target="_blank">
                                            food-recognition-tracker.onrender.com
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LiveAgentDashboard />);
    </script>
</body>
</html>
